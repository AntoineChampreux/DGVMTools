require(rgdal)
require(raster)
require(Cairo)

GFED4.scale.factor <- 0.01

getGFED4Annual <- function(first.year = 1996, last.year = 2012, plot.data = FALSE, as.fraction = TRUE, resolution = "QD"){
  
    
  BA.allyears <- brick()
  
  for(year in first.year:last.year){
    print(paste("Reading Year", year, sep = " "))
        
    # because we only want the annual totals, use the monthly data
    for(month in 1:12){
            
      if(month < 10) {month.str <- paste0("0", month)}
      else{month.str <- paste0(month)}
      
      # add the BA for the month
      if(month == 1) {
        BA <- raster(paste("HDF4_SDS:UNKNOWN:/data/forrest/Fire/GFED4/Monthly/GFED4.0_MQ_", year, month.str, "_BA.hdf:1", sep = ""))      
      } 
      else {
        BA <- BA + raster(paste("HDF4_SDS:UNKNOWN:/data/forrest/Fire/GFED4/Monthly/GFED4.0_MQ_", year, month.str, "_BA.hdf:1", sep = ""))      
      }
    }
    
    
    BA.allyears <-addLayer(BA.allyears, BA)
    
    rm(BA)
    gc()
    
  }
  
  xmin(BA.allyears) <- -180
  xmax(BA.allyears) <- 180
  ymin(BA.allyears) <- -90
  ymax(BA.allyears) <- 90
  projection(BA.allyears) <- "+proj=longlat +datum=WGS84"
  
  
  if(resolution == "HD"){
    BA.allyears <- aggregate(BA.allyears, fun = sum)
  }
  else {
    if(resolution != "QD") stop(paste("Unknown resolution attempted - ", resolution, sep = ""))
  }
  
  # apply scale factor
  BA.allyears <- BA.allyears * GFED4.scale.factor
  
  if(as.fraction){
    # divide by gridcell areas (Note conversion km^2 to hectares)
    BA.allyears <- BA.allyears / ((area(BA.allyears)) * 100)
    names(BA.allyears) <- paste("BAFrac", first.year:last.year, sep = "_")
  } 
  else{
    names(BA.allyears) <- paste("BA", first.year:last.year, sep = "_")
  }
    
  print(BA.allyears)
  
  return(BA.allyears)
  
  
}


#for.Adrian <- getGFED4Annual(first.year = 1997, last.year = 2006, plot.data = FALSE, as.fraction = TRUE, resolution = "HD")
#for.Adrian <- calc(for.Adrian, fun = mean)
#for.Adrian.table <- as.data.frame(as(for.Adrian, "SpatialGridDataFrame")) 
#names(for.Adrian.table) <- c("BAFrac", "Lon", "Lat")
#write.table(for.Adrian.table, "/home/forrest/Projects/Herbivores/Misc/GFED4.1997-2006.txt", row.names= FALSE, quote = FALSE)

  
