#!/usr/bin/Rscript

######################################
###
###         ©©©©©©©©©©©©©
###       ©©©©©©©©©©©©©©©©©
###      ©©©             ©©©
###     ©©©   ©©©©©©©©    ©©©
###    ©©©   ©©       ©©   ©©©
###   ©©©   ©©         ©©   ©©©
###   ©©©               ©©  ©©©
###   ©©©               ©©  ©©©
###   ©©©               ©©  ©©©
###   ©©©   ©©         ©©   ©©©
###    ©©©   ©©       ©©   ©©©
###     ©©©    ©©©©©©©    ©©© 
###      ©©©             ©©©   
###       ©©©©©©©©©©©©©©©©© 
###         ©©©©©©©©©©©©©  
###
###  COPYLEFT:  ALL RIGHTS REVERSED
###
#####################################

require("raster")


readPNVBiomes <- function(plot = FALSE, plot.dir = "."){
  
  file.string = "/home/forrest/Projects/General/PNV/vegmap18_fromTH_Hickler2006.out"

  # get the number of columns which is 
  ncols <- length(names(read.table(file.string, header=TRUE, dec=".",  colClasses="numeric", comment.char="", nrows = 1)))
  
  # read using fread function from data.table but with the white spaces handled correctly using an awk command
  # because at time of writing fread does not handles multiple whitespaces as separators
  PNV.dt <- awkFread(file.string, colNums = c(1:ncols), header=T)
  
  # divide Lon and Lat by 10, offset and London centre
  PNV.dt[,Lon := (Lon/10) + 0.25]
  PNV.dt[,Lat := (Lat/10) + 0.25]
  PNV.dt[, Lon := vapply(PNV.dt[,Lon], 1, FUN = LondonCentre)]
  
  
  # Make into a raster
  PNV.spdf <- makeSPDF(PNV.dt, 0.00001)
  PNV.raster <- raster(PNV.spdf, "Biome")
  
  # reclassify with subs with following logic
  
  #           ORIGINAL ORDERING IN DATA (HICKLER ET AL. 2006)     NEW ORDERING FOLLOW SMITH ET AL.    
  # BIOME 1 - Boreal deciduous forest/woodland                    BIOME 5
  # BIOME 2 - Boreal evergreen forest/woodland                    BIOME 4
  # BIOME 3 - Temperate/Boreal mixed forest                       BIOME 8
  # BIOME 4 - Temperate conifer forest                            BIOME 9
  # BIOME 5 - Temperate deciduous forest                          BIOME 7
  # BIOME 6 - Temperate broadleaved evergreen forest              BIOME 6
  # BIOME 7 - Temperate mixed forest                              BIOME 9
  # BIOME 8 - Tropical seasonal forest                            BIOME 3
  # BIOME 9 - Tropical rain forest                                BIOME 1
  # BIOME 10 - Tropical Deciduous forest                          BIOME 2
  # BIOME 11 - Moist Savannas                                     BIOME 11
  # BIOME 12 - Dry Savannas                                       BIOME 12
  # BIOME 13 - Tall Grassland                                     BIOME 14
  # BIOME 14 - Dry Grassland                                      BIOME 15
  # BIOME 15 - Xeric woodland/shrub                               BIOME 10
  # BIOME 16 - Arid shrubland/steppe                              BIOME 16
  # BIOME 17 - Desert                                             BIOME 17
  # BIOME 18 - Arctic/alpine tundra                               BIOME 13
  
  
  # from above orderings
  subs.rules <- data.frame(id=1:18, v=c(5,4,8,9,7,6,9,3,1,2,11,12,14,15,10,16,17,13))
  PNV.raster <- subs(PNV.raster, subs.rules)
  
  # plot if requested and return
  if(plot){ plotGlobalBiomeMap(PNV.raster, plot.dir = plot.dir, filename = "PNV2006.png") }
  return(PNV.raster)
 
}